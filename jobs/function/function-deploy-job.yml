parameters:
- name: environmentName
  type: string

- name: siteName
  type: string  

- name: planType
  type: string

- name: regionName
  type: string  

jobs:
  - deployment: AzureFunction
    displayName: Deploy Azure Function
    environment: '${{ parameters.environmentName }}'
    variables:
    - template: '../../variables/pipeline-variables.${{ parameters.environmentName }}.yml'
      parameters:
        serviceName: ${{ parameters.siteName }}
    strategy: 
      runOnce:
        deploy:
          steps:

          - ${{ if and(eq(parameters.planType, 'AppServicePlan'), eq(parameters.regionName, 'AU')) }}:
            - bash: |
                echo "##vso[task.setvariable variable=functionPlanName;]$(AppServicePlanName)"
              displayName: App Service Plan (AU region)
          - ${{ if and(eq(parameters.planType, 'Consumption'), eq(parameters.regionName, 'AU')) }}:
            - bash: |
                echo "##vso[task.setvariable variable=functionPlanName;]$(ConsumptionPlanName)"
              displayName: Consumption Plan (AU region)
          - ${{ if and(eq(parameters.planType, 'AppServicePlan'), eq(parameters.regionName, 'US')) }}:
            - bash: |
                echo "##vso[task.setvariable variable=functionPlanName;]$(AppServicePlanName)"
              displayName: Check App Service Plan (US region)
          - ${{ if and(eq(parameters.planType, 'Consumption'), eq(parameters.regionName, 'US')) }}:
            - bash: |
                echo "##vso[task.setvariable variable=functionPlanName;]$(ConsumptionPlanName)"
              displayName: Check App Service Plan (US region)
          - script: |
              echo $(functionPlanName) 
            displayName: Display Plan name

          - task: AzureCLI@2
            displayName: 'Deploy Azure Function'
            inputs:
              azureSubscription: ${{ variables.AzureSubscriptionName }}
              scriptType: pscore
              scriptLocation: inlineScript
              inlineScript: |
                az account set --subscription ${{variables.AzureSubscriptionId}}
                az deployment sub create `
                --name azfn.deploy.v1 `
                --location ${{variables.AzureLocationShort}} `
                --template-file "$(Pipeline.Workspace)/drop/bicep/main.bicep" `
                --parameters `
                siteName=${{parameters.siteName}} `
                resourceGroupName=${{variables.ResourceGroupName}} `
                resourceGroupLocation=${{variables.AzureLocationShort}} `
                storageAccountName=${{variables.StorageAccountName}} `
                tags='${{variables.AzureTags}}' `
                hostingPlanName=$(functionPlanName)
            

 