parameters:
- name: environmentName
  type: string

- name: siteName
  type: string  

- name: planType
  type: string

- name: regionName
  type: string  

jobs:
  - deployment: AzureFunction
    displayName: Deploy Azure Function
    environment: '${{ parameters.environmentName }}'
    variables:
    - template: '../../variables/pipeline-variables.${{ parameters.environmentName }}.yml'
      parameters:
        serviceName: siteName
    strategy: 
      runOnce:
        deploy:
          steps:

          - script: |
              echo "Determine plan"
              echo ${{ parameters.regionName }}
              echo ${{ parameters.planType }}
            displayName: Step 1
          
          - bash:
              echo "##vso[task.setvariable variable=test;]${{ parameters.regionName }}"
            displayName: Step 2

          - script: |
              echo $(test)
            displayName: Step 3
              
          - ${{ if and(eq(parameters.planType, 'AppServicePlan'), eq(parameters.regionName, 'AU')) }}:
            - bash: |
                echo "AU"
                echo "##vso[task.setvariable variable=functionPlanName;]$(AppServicePlanName)"
              displayName: Step 4
          - ${{ if and(eq(parameters.planType, 'Consumption'), eq(parameters.regionName, 'UK')) }}:
            - bash: |
                echo "UK"
                echo "##vso[task.setvariable variable=functionPlanName;]$(ConsumptionPlanName)"
              displayName: Step 5
          - script: |
              echo $(functionPlanName) 
            displayName: Step 6

          # - task: AzureCLI@2
          #   displayName: 'Deploy Azure Function'
          #   inputs:
          #     azureSubscription: ${{ variables.AzureSubscriptionName }}
          #     scriptType: pscore
          #     scriptLocation: inlineScript
          #     inlineScript: |
          #       az account set --subscription ${{variables.AzureSubscriptionId}}
          #       az deployment sub create `
          #       --name azfn.deploy.v1 `
          #       --location ${{variables.AzureLocationShort}} `
          #       --template-file "$(Pipeline.Workspace)/drop/bicep/main.bicep" `
          #       --parameters `
          #       siteName=${{parameters.siteName}} `
          #       resourceGroupName=${{variables.ResourceGroupName}} `
          #       resourceGroupLocation=${{variables.AzureLocationShort}} `
          #       storageAccountName=${{variables.StorageAccountName}} `
          #       tags='${{variables.AzureTags}}' `
          #       hostingPlanName=$(functionPlanName)
            

 